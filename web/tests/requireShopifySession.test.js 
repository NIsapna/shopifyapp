import test from "node:test";
import assert from "node:assert/strict";
import requireShopifySession from "../middleware/requireShopifySession.js";
import jwt from "jsonwebtoken";

process.env.SHOPIFY_API_SECRET = process.env.SHOPIFY_API_SECRET || "test_secret";

const createResponse = () => {
  const res = {};
  res.statusCode = 200;
  res.payload = null;
  res.status = (code) => {
    res.statusCode = code;
    return res;
  };
  res.json = (payload) => {
    res.payload = payload;
    return res;
  };
  return res;
};

test("requireShopifySession rejects missing Authorization header", async () => {
  const req = { headers: {} };
  const res = createResponse();
  await requireShopifySession(req, res, () => {});
  assert.equal(res.statusCode, 401);
  assert.equal(res.payload.error, "Missing session token");
});

test("requireShopifySession attaches shop info when token is valid", async () => {
  const token = jwt.sign(
    {
      dest: "https://demo-store.myshopify.com",
      iat: Date.now() / 1000,
    },
    process.env.SHOPIFY_API_SECRET || "test_secret",
    { algorithm: "HS256" }
  );

  const req = { headers: { authorization: `Bearer ${token}` } };
  const res = createResponse();
  let nextCalled = false;
  await requireShopifySession(req, res, () => {
    nextCalled = true;
  });

  assert.equal(nextCalled, true);
  assert.equal(req.shopify.shop, "demo-store.myshopify.com");

});
